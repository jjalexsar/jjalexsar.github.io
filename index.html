<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>/post 목록</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <h1>글 목록</h1>
  <div id="status" style="color:#c00; margin:6px 0;"></div>
  <ul id="list"></ul>
  <hr>
  <div id="content">목록에서 클릭하세요.</div>

<script>
  // === 여기를 본인 레포 정보로 바꾸세요 ===
  const GITHUB_USER = "your-user";   // 예: jejun-park
  const REPO        = "your-repo";   // 예: blog

  // 자동 탐색 후보들
  const BRANCHES = ["main", "master", "gh-pages"];
  const DIRS     = ["post", "src/post"];

  const statusEl  = document.getElementById("status");
  const listEl    = document.getElementById("list");
  const contentEl = document.getElementById("content");

  const triesLog = [];

  async function fetchJson(url){
    const res = await fetch(url, { headers: { "Accept":"application/vnd.github+json" } });
    let data = null;
    try { data = await res.json(); } catch(_) {}
    return { ok: res.ok, status: res.status, data };
  }

  async function findWorkingEndpoint(){
    for (const branch of BRANCHES){
      for (const dir of DIRS){
        const url = `https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${encodeURIComponent(dir)}?ref=${encodeURIComponent(branch)}`;
        const { ok, status, data } = await fetchJson(url);
        triesLog.push(`GET ${url} -> ${status}${ok?" OK":""}`);
        if (ok && Array.isArray(data)) return { branch, dir, items: data };
      }
    }
    return null;
  }

  function showStatus(){
    statusEl.style.whiteSpace = "pre-wrap";
    statusEl.textContent = triesLog.join("\n");
  }

  function displayList(files, dir){
    const mdFiles = files.filter(f => f.type==="file" && /\.md(?:own)?$/i.test(f.name))
                         .sort((a,b)=> a.name.localeCompare(b.name,"ko"));

    if (!mdFiles.length){
      statusEl.textContent = "경로는 찾았지만 .md 파일이 없습니다.";
      return;
    }

    mdFiles.forEach(f => {
      const li = document.createElement("li");
      const a  = document.createElement("a");
      a.href = "#";
      a.textContent = f.name;
      a.onclick = async (e)=>{
        e.preventDefault();
        const md = await fetch(f.download_url).then(r=>r.text());
        contentEl.innerHTML = marked.parse(md);

        // 상대경로(./img.png)를 dir 기준으로 처리
        const base = document.createElement("base");
        base.href = `/${dir}/`;
        document.head.querySelector("base")?.remove();
        document.head.prepend(base);
      };
      li.appendChild(a);
      listEl.appendChild(li);
    });
  }

  (async function init(){
    const found = await findWorkingEndpoint();
    if (!found){
      triesLog.push("\n❌ 모든 조합에서 404/오류가 발생했습니다.\n- 사용자명/레포명 확인\n- 브랜치명(main/master/gh-pages) 확인\n- 경로(post 또는 src/post) 확인\n- 레포가 Private이면 브라우저에서 접근 불가");
      showStatus();
      return;
    }
    triesLog.push(`\n✅ 사용 중: BRANCH=${found.branch}, DIR=${found.dir}`);
    showStatus();
    displayList(found.items, found.dir);
  })();
</script>
</body>
</html>
